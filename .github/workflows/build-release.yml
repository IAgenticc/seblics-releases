name: Build Releases

on:
  push:
    tags:
      - "v*"

env:
  RELEASES_REPO: IAgenticc/seblics-releases
  SOURCE_REPO: Sebuliba-Adrian/seblics
  MOBILE_REPO: IAgenticc/seblics-mobile

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! gh release view "v${VERSION}" --repo "${{ env.RELEASES_REPO }}"; then
            cat > /tmp/release-notes.md << 'NOTES'
## Seblics Desktop App

### Downloads

| Platform | File |
|----------|------|
| Windows (64-bit) | Seblics_x.x.x_x64-setup.exe |
| macOS (Apple Silicon) | Seblics_x.x.x_aarch64.dmg |
| macOS (Intel) | Seblics_x.x.x_x64.dmg |
| Android (APK) | Seblics_x.x.x.apk |

### Installation

**Windows:** Download and run the .exe installer.

**macOS:** Download the .dmg, open it, and drag Seblics to Applications.

**Android:** Install the APK on your device.
NOTES

            gh release create "v${VERSION}" \
              --repo "${{ env.RELEASES_REPO }}" \
              --title "Seblics v${VERSION}" \
              --draft \
              --notes-file /tmp/release-notes.md
          fi

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.RELEASES_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Python dependencies for Faster-Whisper
        run: |
          pip install faster-whisper pyinstaller

      - name: Download Whisper model and build Faster-Whisper exe
        working-directory: desktop/src-tauri
        run: |
          python -c "from faster_whisper import WhisperModel; WhisperModel('base', device='cpu'); print('Model downloaded')"

          $cache = "$env:USERPROFILE\.cache\huggingface\hub"
          $modelDir = Get-ChildItem -Path $cache -Filter "models--Systran--faster-whisper-base" -Recurse -Directory | Select-Object -First 1
          $snapshot = Get-ChildItem -Path "$($modelDir.FullName)\snapshots" -Directory | Select-Object -First 1

          New-Item -ItemType Directory -Force -Path "models\faster-whisper-base"
          Copy-Item -Path "$($snapshot.FullName)\*" -Destination "models\faster-whisper-base\" -Recurse

          python build_faster_whisper.py

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Tauri app
        working-directory: desktop
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build

      - name: Upload Windows installer
        env:
          GH_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        shell: bash
        run: |
          EXE_FILE=$(find desktop/src-tauri/target/release/bundle/nsis -name "*.exe" | head -1)
          if [ -n "$EXE_FILE" ]; then
            gh release upload "v${{ needs.create-release.outputs.version }}" "$EXE_FILE" --repo "${{ env.RELEASES_REPO }}" --clobber
          else
            echo "No exe file found!"
            exit 1
          fi

  build-macos:
    needs: create-release
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - name: arm64
            rust_target: ""
            dmg_dir: desktop/src-tauri/target/release/bundle/dmg
          - name: x64
            rust_target: x86_64-apple-darwin
            dmg_dir: desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.RELEASES_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target.rust_target }}

      - name: Install LLVM (for bindgen)
        run: |
          brew install llvm
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV

      - name: Install Python dependencies for Faster-Whisper
        run: |
          pip install faster-whisper pyinstaller

      - name: Download Whisper model and build Faster-Whisper
        working-directory: desktop/src-tauri
        run: |
          python -c "from faster_whisper import WhisperModel; WhisperModel('base', device='cpu'); print('Model downloaded')"

          MODEL_PATH=$(python -c "from huggingface_hub import scan_cache_dir; cache = scan_cache_dir(); repo = [r for r in cache.repos if 'faster-whisper-base' in r.repo_id][0]; print(list(repo.revisions)[0].snapshot_path)")
          mkdir -p models/faster-whisper-base
          cp -r "$MODEL_PATH"/* models/faster-whisper-base/

          python build_faster_whisper.py

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Tauri app
        working-directory: desktop
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          if [ -n "${{ matrix.target.rust_target }}" ]; then
            npm run tauri build -- --target ${{ matrix.target.rust_target }}
          else
            npm run tauri build
          fi

      - name: Upload macOS DMG
        env:
          GH_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        run: |
          DMG_FILE=$(find "${{ matrix.target.dmg_dir }}" -name "*.dmg" | head -1)
          if [ -n "$DMG_FILE" ]; then
            gh release upload "v${{ needs.create-release.outputs.version }}" "$DMG_FILE" --repo "${{ env.RELEASES_REPO }}" --clobber
          else
            echo "No DMG file found!"
            exit 1
          fi

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout mobile repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MOBILE_REPO }}
          token: ${{ secrets.RELEASES_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build Android APK
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          eas build -p android --profile preview --non-interactive --wait
          eas build:download --latest --platform android --path android-release.apk

      - name: Upload Android APK
        env:
          GH_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        run: |
          if [ -f android-release.apk ]; then
            gh release upload "v${{ needs.create-release.outputs.version }}" android-release.apk --repo "${{ env.RELEASES_REPO }}" --clobber
          else
            echo "No APK file found!"
            exit 1
          fi

  publish-release:
    needs: [create-release, build-windows, build-macos, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "v${{ needs.create-release.outputs.version }}" \
            --repo "${{ env.RELEASES_REPO }}" \
            --draft=false
